"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

const pg_1 = require("@databases/pg");

async function getSearchPath(connection, options = {}) {
  const [[{
    current_user
  }], [{
    search_path
  }], namespaces] = await Promise.all([connection.query(pg_1.sql`SELECT current_user;`), connection.query(pg_1.sql`SHOW search_path;`), options.includeNonExistantSchemas ? Promise.resolve(null) : connection.query(pg_1.sql`SELECT nspname FROM pg_catalog.pg_namespace`)]);
  const schemaNames = namespaces && namespaces.map(n => n.nspname);
  const searchPath = search_path.split(',').map(p => p.trim()).map(p => p[0] === '"' ? JSON.parse(p) : p).map(p => p === '$user' ? current_user : p).filter(p => !schemaNames || schemaNames.includes(p));
  return searchPath;
}

exports.default = getSearchPath;