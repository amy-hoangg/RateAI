"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

const pg_1 = require("@databases/pg");

const getClasses_1 = require("./getClasses");

async function getConstraints(connection, query) {
  const conditions = getClasses_1.classQuery(query);
  const constraints = await connection.query(pg_1.sql`
    SELECT
      conname AS "constraintName",
      contype AS "constraintType",
      conrelid AS "classID",
      confrelid AS "referencedClassID",
      confupdtype AS "foreignKeyUpdateAction",
      confdeltype AS "foreignKeyDeletionAction",
      confmatchtype AS "foreignKeyMatchType",
      conkey AS "tableAttributeNumbers",
      confkey AS "referencedAttributeNumbers",
      pg_get_constraintdef(c.oid, true) AS "constraintDescription"
    FROM pg_catalog.pg_constraint c
    INNER JOIN pg_catalog.pg_class cls
      ON (c.conindid = cls.oid)
    INNER JOIN pg_catalog.pg_namespace ns
      ON (c.connamespace = ns.oid)
    ${conditions.length ? pg_1.sql`WHERE ${pg_1.sql.join(conditions, pg_1.sql` AND `)}` : pg_1.sql``}
    ORDER BY ns.nspname ASC, c.conname ASC
  `);
  return constraints;
}

exports.default = getConstraints;